@page "/Manager"
@using System.Collections.Generic
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
<MudPaper Class="pb-10">
    <MudGrid Class="px-5" Spacing="1" Justify="Justify.Center">
        <MudItem md="3" sm="6" xs="12">
            <SearchTextBox @bind-Value="Model.InvoiceId" Label="Invoice Id" SearchFunction="@(()=>table.ReloadServerData())"></SearchTextBox>
        </MudItem>
        <MudItem md="3" sm="6" xs="12">
            <SearchTextBox MaxLenght="10" InputType="InputType.Telephone" @bind-Value="Model.MobileNumber" Label="Mobile Number" SearchFunction="@(()=>table.ReloadServerData())"></SearchTextBox>
        </MudItem>
        <MudItem md="3" sm="6" xs="12">
            <MudSelect OnKeyDown="SearchEnter" SelectedValuesChanged="@((e)=>table.ReloadServerData())" Immediate="true" T="int" @bind-Value="SelectedMode" HelperText="(Optional)" Text="ALL" Label="Mode" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem Value="-1">ALL</MudSelectItem>
                <MudSelectItem Value="2">Complete</MudSelectItem>
                <MudSelectItem Value="1">Pending</MudSelectItem>
                <MudSelectItem Value="0">Not Complete</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem md="3" sm="6" xs="12">
            @if (Payments != null)
            {
                <MudSelect OnKeyDown="SearchEnter" SelectedValuesChanged="@((e)=>table.ReloadServerData())" Immediate="true" T="string" @bind-Value="SelectedPaymnet" Text="ALL" HelperText="(Optional)" Label="Payment" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var item in Payments)
                    {
                        <MudSelectItem Value="@item">@item</MudSelectItem>

                    }
                </MudSelect>
            }
        </MudItem>
        <MudItem md="12">
            <MudExpansionPanels DisableGutters="true" DisableBorders="true" Elevation="0">
                <MudExpansionPanel Text="Advanced Search" Icon="@Icons.Filled.YoutubeSearchedFor" DisableGutters="true">
                    <MudGrid Spacing="1" Justify="Justify.Center">
                        <MudItem md="3" sm="6" xs="12">
                            <SearchTextBox @bind-Value="Model.GiftCode" Label="Gift Code" SearchFunction="@(()=>table.ReloadServerData())"></SearchTextBox>
                        </MudItem>

                        <MudItem md="3" sm="6" xs="12">
                            <SearchNumberBox @bind-Value="Model.DiscountValue" Label="Discount" SearchFunction="@(()=>table.ReloadServerData())" Adornment="Adornment.End" AdornmentText="%"></SearchNumberBox>
                        </MudItem>
                        <MudItem md="3" sm="6" xs="12">
                            @if (Emarits != null)
                            {
                                <MudSelect OnKeyDown="SearchEnter" SelectedValuesChanged="@((e)=>table.ReloadServerData())" Immediate="true" T="int" @bind-Value="SelectedEmarit" HelperText="(Optional)" Text="ALL" Label="Emirate" AnchorOrigin="Origin.BottomCenter">
                                    @foreach (var item in Emarits)
                                    {
                                        <MudSelectItem Value="item.Id">@item.EmariteName</MudSelectItem>

                                    }
                                </MudSelect>
                            }
                        </MudItem>
                        <MudItem md="3" sm="6" xs="12">
                            <SearchTextBox @bind-Value="Model.Plan" Label="Plan" SearchFunction="@(()=>table.ReloadServerData())"></SearchTextBox>
                        </MudItem>
                        <MudItem md="3" sm="6" xs="12">
                            @if (Branches != null)
                            {
                                <MudSelect OnKeyDown="SearchEnter" SelectedValuesChanged="@((e)=>table.ReloadServerData())" Immediate="true" T="int" @bind-Value="SelectedBranch" HelperText="(Optional)" Text="ALL" Label="Branch" AnchorOrigin="Origin.BottomCenter">
                                    @foreach (var item in Branches)
                                    {
                                        <MudSelectItem Value="item.Id">@item.BranchName</MudSelectItem>

                                    }
                                </MudSelect>
                            }
                        </MudItem>

                        <MudItem md="3" sm="6" xs="12">
                            <MudSelect OnKeyDown="SearchEnter" SelectedValuesChanged="@((e)=>table.ReloadServerData())" Immediate="true" T="int" @bind-Value="SelectedType" HelperText="(Optional)" Text="ALL" Label="Type" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="-1">ALL</MudSelectItem>
                                <MudSelectItem Value="1">Subsctiption</MudSelectItem>
                                <MudSelectItem Value="0">Appointment</MudSelectItem>
                            </MudSelect>

                        </MudItem>
                        <MudItem md="3" sm="6" xs="12">
                            @if (Agents != null)
                            {
                                <MudSelect OnKeyDown="SearchEnter" SelectedValuesChanged="@((e)=>table.ReloadServerData())" Immediate="true" T="int" @bind-Value="SelectedAgent" HelperText="(Optional)" Text="ALL" Label="Agent" AnchorOrigin="Origin.BottomCenter">
                                    @foreach (var item in Agents)
                                    {
                                        <MudSelectItem Value="item.AgentID">@item.AgentName</MudSelectItem>

                                    }
                                </MudSelect>
                            }
                        </MudItem>
                        <MudItem md="3" sm="6" xs="12">
                            <MudDatePicker @ref="_picker" PickerVariant="PickerVariant.Dialog" Label="Start Date" HelperText="(Optional)" @bind-Date="Model.StartDate" AutoClose="true">
                                <PickerActions>
                                    <MudButton Class="mr-auto align-self-start" OnClick="@(() => _picker.Clear())">Clear</MudButton>
                                    <MudButton OnClick="@(() => _picker.Close(false))">Cancel</MudButton>
                                    <MudButton Color="Color.Primary" OnClick="@(() => { _picker.Close(); table.ReloadServerData(); })">Ok</MudButton>
                                </PickerActions>
                            </MudDatePicker>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudItem>

        <MudItem md="5" sm="11" xs="11">
            <WaitingSaveButton WaitingText="Searching.." OnClick="Search" IsProcessing="IsSerching" FullWidth="true" StartIcon="@Icons.Material.Filled.Search" Color="Color.Primary" Size="Size.Large" Variant="Variant.Outlined" Text="Search"></WaitingSaveButton>
        </MudItem>
        <MudItem md="1" sm="1" xs="1">
            <MudButton EndIcon="@Icons.Material.Filled.Clear" Color="Color.Primary" Size="Size.Large" Variant="Variant.Filled" OnClick="ResetSearch">Reset</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>
<MudSpacer />
<MudPaper>
    <MudTable Class="pt-5" Style=" width: max-content; align-content:center" RowsPerPage="100" ServerData="@(new Func<TableState, Task<TableData<SubscriptionsResponse>>>(ServerReload))"
              Dense="true" HorizontalScrollbar="true" FixedFooter="true" Striped="true" Hover="true" @ref="table">

        <ToolBarContent>
            <MudText Typo="Typo.h6">Invoices</MudText>
            <MudSpacer />
        </ToolBarContent>
        <ColGroup>
            <col />
            <col style="width:min-content" />
        </ColGroup>
        <HeaderContent>
            <MudTh><MudTableSortLabel SortLabel="Count_field" T="SubscriptionsResponse"> </MudTableSortLabel></MudTh>
            <MudTh Style=" width: max-content;"><MudTableSortLabel SortLabel="Id_field" T="SubscriptionsResponse">Invoice Number</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="SubFrom_field" T="SubscriptionsResponse">Payment</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="AgentName_field" T="SubscriptionsResponse">Agent</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="FullName_field" T="SubscriptionsResponse">Full Name</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="Mobile_field" T="SubscriptionsResponse">Mobile</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="Mode_field" T="SubscriptionsResponse">Mode</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="Emarite_field" T="SubscriptionsResponse">Emirate</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="DeliveryStartingDay_field" T="SubscriptionsResponse">Start Date</MudTableSortLabel></MudTh>
            <MudTh Style=" width: min-content;"><MudTableSortLabel SortLabel="PlanName_field" T="SubscriptionsResponse">Plan</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="Area_field" T="SubscriptionsResponse">Area</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="TotalPrice_field" T="SubscriptionsResponse">Total</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="Code_field" T="SubscriptionsResponse">Gift Code</MudTableSortLabel></MudTh>
            <MudTh Style=" width: fit-content;"><MudTableSortLabel SortLabel="Discount_field" T="SubscriptionsResponse">Discount</MudTableSortLabel></MudTh>



        </HeaderContent>
        <RowTemplate>
            <MudTd Style=" width: fit-content;" DataLabel="#">
                @if (CanDelete)
                {
                    <MudTooltip Text="Delete"><MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"></MudIconButton></MudTooltip>
                }
                @if (CanViewDetails)
                {
                    <MudTooltip Text="Preview"> <MudIconButton Icon="@Icons.Material.Filled.Preview" Size="Size.Small"></MudIconButton></MudTooltip>
                }
                @if (CanAddCid)
                {
                    <MudTooltip Text="Add CID">   <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small"></MudIconButton></MudTooltip>
                }

            </MudTd>
            <MudTd Style=" width: max-content;" DataLabel="Id"><MudChip id="CopyItem" @onclick="@(()=> CopyInvNum(context.InvoiceNum))" Variant="Variant.Text" Color="Color.Secondary"><strong>@context.InvoiceNum</strong></MudChip></MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Payment">@context.SubFrom</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Agent">@context.AgentName</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Full Name">@context.FullName</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Mobile">@context.Mobile</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Mode"><MudChip Color="@(ModeColor(context.Mode))">@context.Mode</MudChip></MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Emirate">@(string.IsNullOrWhiteSpace(context.Emarite) ? "--" : context.Emarite)</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Start Date">@context.DeliveryStartingDay.Date.ToString("d/M/yyyy")</MudTd>
            <MudTd Style=" width: min-content;" DataLabel="Plan">@context.PlanName</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Area">@(string.IsNullOrWhiteSpace(context.Area) ? "--" : context.Area)</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Total">@context.TotalPrice AED</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Gift Code">@(string.IsNullOrWhiteSpace(context.Code) ? "--" : context.Code)</MudTd>
            <MudTd Style=" width: fit-content;" DataLabel="Discount">@context.Discount %</MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No matching records found</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudProgressCircular Class="ms-n1" Size="Size.Large" Indeterminate="true" />
            <MudText Class="ms-2">Loading Data ..</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager HorizontalAlignment="HorizontalAlignment.Center" />
        </PagerContent>
    </MudTable>

</MudPaper>


@code {
    private ClaimsPrincipal AuthenticationStateProviderUser { get; set; }
    MudDatePicker _picker;
    public List<BranchesResponse> Branches { get; set; } = new();
    public List<AgentsResponse> Agents { get; set; } = new();
    public List<string> Payments { get; set; } = new();
    public List<EmaritsResponse> Emarits { get; set; } = new();
    public ManagerRequest Model { get; set; }
    public int PageNumber { get; set; } = 1;
    public int PageSize { get; set; } = 100;
    public int SelectedAgent { get; set; } = 0;
    public int SelectedBranch { get; set; } = 0;
    public int SelectedEmarit { get; set; } = 0;
    public string SelectedPaymnet { get; set; } = "ALL";
    public bool IsSerching { get; set; } = false;
    public int SelectedMode { get; set; } = -1;
    public int SelectedType { get; set; } = -1;


    /// <summary>
    /// ////////////////Result Table
    /// </summary>
    /// <returns></returns>
    ///
    public bool CanViewDetails { get; set; }
    public bool CanDelete { get; set; }
    public bool CanAddCid { get; set; }
    private async Task GetPermmision()
    {
        AuthenticationStateProviderUser = await _stateProvider.GetAuthenticationStateProviderUserAsync();
        var CanViewDetailsResponse = await _authorizationService.AuthorizeAsync(AuthenticationStateProviderUser, Permissions.ManagerDashboard.ViewDetails);
        var CanAddCidResponse = await _authorizationService.AuthorizeAsync(AuthenticationStateProviderUser, Permissions.ManagerDashboard.AddCid);
        var CanDeleteResponse = await _authorizationService.AuthorizeAsync(AuthenticationStateProviderUser, Permissions.ManagerDashboard.Delete);
        CanViewDetails = CanViewDetailsResponse.Succeeded;
        CanAddCid = CanAddCidResponse.Succeeded;
        CanDelete = CanDeleteResponse.Succeeded;
        StateHasChanged();
    }

    private IEnumerable<SubscriptionsResponse> pagedData;
    private MudTable<SubscriptionsResponse> table;

    private int totalItems;
    private string searchString = null;
    private async void Search()
    {
        await table.ReloadServerData();
    }
    private async Task<TableData<SubscriptionsResponse>> ServerReload(TableState state)
    {
        Model.AgentID = SelectedAgent == 0 ? null : SelectedAgent;
        Model.BranchID = SelectedBranch == 0 ? null : SelectedBranch;
        Model.EmariteID = SelectedEmarit == 0 ? null : SelectedEmarit;
        Model.SubFrom = SelectedPaymnet == "ALL" ? string.Empty : SelectedPaymnet;
        Model.Mode = SelectedMode == -1 ? null : SelectedMode;
        Model.InvType = SelectedType == -1 ? null : SelectedType;

        var response = await _managerDashboard.GetSubscriptions(Model, state.PageSize, state.Page + 1);
        IEnumerable<SubscriptionsResponse> data = response.Data;
        totalItems = response.TotalCount;
        switch (state.SortLabel)
        {
            case "Id_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Id);
                break;
            case "SubFrom_field":
                data = data.OrderByDirection(state.SortDirection, o => o.SubFrom);
                break;
            case "FullName_field":
                data = data.OrderByDirection(state.SortDirection, o => o.FullName);
                break;
            case "Mobile_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Mobile);
                break;
            case "Code_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Code);
                break;
            case "AgentName_field":
                data = data.OrderByDirection(state.SortDirection, o => o.AgentName);
                break;
            case "Discount_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Discount);
                break;
            case "TotalPrice_field":
                data = data.OrderByDirection(state.SortDirection, o => o.TotalPrice);
                break;
            case "DeliveryStartingDay_field":
                data = data.OrderByDirection(state.SortDirection, o => o.DeliveryStartingDay);
                break;
            case "Mode_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Mode);
                break;
            case "PlanName_field":
                data = data.OrderByDirection(state.SortDirection, o => o.PlanName);
                break;
            case "Area_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Area);
                break;
            case "Emarite_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Emarite);
                break;
        }

        //  pagedData = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
        return new TableData<SubscriptionsResponse>() { TotalItems = totalItems, Items = data };
    }
    private void SearchEnter(KeyboardEventArgs e)
    {

        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            table.ReloadServerData();
        }

    }
    private async Task SearchEnter2(KeyboardEventArgs e)
    {

        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await table.ReloadServerData();
        }

    }
    private void OnSearch(string text)
    {
        searchString = text;
        table.ReloadServerData();
    }

    public Color ModeColor(string Mode)
    {
        switch (Mode)
        {
            case "Completed":
                return Color.Success;
            case "Pending":
                return Color.Primary;
            case "NotComplete":
                return Color.Warning;
            default: return Color.Success;


        }

    }

    private void CopyInvNum(string invNum)
    {
        _snackBar.Add("Copied To Clipboard", Severity.Normal,
            (o) => { o.VisibleStateDuration = 2000; o.ShowCloseIcon = false; });
        JS.InvokeVoidAsync("clipboardCopy.copyText", invNum);
    }

    protected override async Task OnInitializedAsync()
    {
        Model = new ManagerRequest();
        await GetPermmision();
        Agents = await _managerDashboard.GetAgents();
        Branches = await _managerDashboard.GetBranches();
        Payments = await _managerDashboard.GetPayments();
        Emarits = await _managerDashboard.GetEmarits();
        Agents.Insert(0, new AgentsResponse() { AgentID = 0, AgentName = "ALL" });
        Branches.Insert(0, new BranchesResponse() { Id = 0, BranchName = "ALL" });
        Emarits.Insert(0, new EmaritsResponse() { Id = 0, EmariteName = "ALL" });
        Payments.Insert(0, "ALL");

    }

    private void ResetSearch()
    {
        Model = new ManagerRequest();
        SelectedAgent = 0;
        SelectedBranch = 0;
        SelectedEmarit = 0;
        SelectedPaymnet = "ALL";
        SelectedMode = -1;
    }
}
